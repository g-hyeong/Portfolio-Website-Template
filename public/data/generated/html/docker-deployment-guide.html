<h1 class="text-2xl font-bold text-foreground mt-8 mb-4 first:mt-0">Docker를 활용한 배포 전략</h1>
<p class="text-foreground-secondary leading-relaxed mb-4">Docker 컨테이너를 활용한 효율적인 애플리케이션 배포 방법과 CI/CD 파이프라인 구축에 대해 설명합니다.</p>
<h2 class="text-xl font-bold text-foreground mt-6 mb-3">Docker 기본 개념</h2>
<h3 class="text-lg font-semibold text-foreground mt-4 mb-2">컨테이너 vs 가상머신</h3>
<ul class="list-disc list-inside text-foreground-secondary mb-4 space-y-1">
<li class="text-foreground-secondary"><strong class="font-bold text-foreground">컨테이너</strong>: OS 커널을 공유하여 가벼운 가상화</li>
<li class="text-foreground-secondary"><strong class="font-bold text-foreground">가상머신</strong>: 하드웨어를 가상화하여 완전한 OS 실행</li>
</ul>
<h3 class="text-lg font-semibold text-foreground mt-4 mb-2">Dockerfile 작성</h3>
<pre class="rounded-lg overflow-x-auto mb-4 bg-surface text-foreground p-4"><code class="hljs language-dockerfile text-foreground px-2 py-1 rounded text-sm bg-surface-secondary border border-border bg-surface p-4 rounded-lg overflow-x-auto"># Next.js 애플리케이션 Dockerfile
FROM node:18-alpine AS deps
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM node:18-alpine AS runner
WORKDIR /app
ENV NODE_ENV production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000
ENV PORT 3000

CMD ["node", "server.js"]
</code></pre>
<h2 class="text-xl font-bold text-foreground mt-6 mb-3">Docker Compose 활용</h2>
<h3 class="text-lg font-semibold text-foreground mt-4 mb-2">개발 환경 구성</h3>
<pre class="rounded-lg overflow-x-auto mb-4 bg-surface text-foreground p-4"><code class="hljs language-yaml text-foreground px-2 py-1 rounded text-sm bg-surface-secondary border border-border bg-surface p-4 rounded-lg overflow-x-auto"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3000:3000"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">NODE_ENV=development</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DATABASE_URL=postgresql://user:password@db:5432/myapp</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">db</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">.:/app</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/app/node_modules</span>

  <span class="hljs-attr">db:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres:15</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">POSTGRES_DB:</span> <span class="hljs-string">myapp</span>
      <span class="hljs-attr">POSTGRES_USER:</span> <span class="hljs-string">user</span>
      <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-string">password</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"5432:5432"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">postgres_data:/var/lib/postgresql/data</span>

  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7-alpine</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"6379:6379"</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">postgres_data:</span>
</code></pre>
<h3 class="text-lg font-semibold text-foreground mt-4 mb-2">프로덕션 환경 구성</h3>
<pre class="rounded-lg overflow-x-auto mb-4 bg-surface text-foreground p-4"><code class="hljs language-yaml text-foreground px-2 py-1 rounded text-sm bg-surface-secondary border border-border bg-surface p-4 rounded-lg overflow-x-auto"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">myapp:latest</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3000:3000"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">NODE_ENV=production</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
      <span class="hljs-attr">resources:</span>
        <span class="hljs-attr">limits:</span>
          <span class="hljs-attr">memory:</span> <span class="hljs-string">512M</span>
        <span class="hljs-attr">reservations:</span>
          <span class="hljs-attr">memory:</span> <span class="hljs-string">256M</span>

  <span class="hljs-attr">nginx:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:alpine</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"80:80"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"443:443"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx.conf:/etc/nginx/nginx.conf</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./ssl:/etc/nginx/ssl</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>
</code></pre>
<h2 class="text-xl font-bold text-foreground mt-6 mb-3">CI/CD 파이프라인</h2>
<h3 class="text-lg font-semibold text-foreground mt-4 mb-2">GitHub Actions 워크플로우</h3>
<pre class="rounded-lg overflow-x-auto mb-4 bg-surface text-foreground p-4"><code class="hljs language-yaml text-foreground px-2 py-1 rounded text-sm bg-surface-secondary border border-border bg-surface p-4 rounded-lg overflow-x-auto"><span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Production</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build-and-deploy:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
    
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Buildx</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/setup-buildx-action@v2</span>
    
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Login</span> <span class="hljs-string">to</span> <span class="hljs-string">DockerHub</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/login-action@v2</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DOCKERHUB_USERNAME</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">password:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DOCKERHUB_TOKEN</span> <span class="hljs-string">}}</span>
    
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">and</span> <span class="hljs-string">push</span> <span class="hljs-string">Docker</span> <span class="hljs-string">image</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/build-push-action@v4</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">context:</span> <span class="hljs-string">.</span>
        <span class="hljs-attr">push:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">tags:</span> <span class="hljs-string">myapp:${{</span> <span class="hljs-string">github.sha</span> <span class="hljs-string">}},myapp:latest</span>
        <span class="hljs-attr">cache-from:</span> <span class="hljs-string">type=gha</span>
        <span class="hljs-attr">cache-to:</span> <span class="hljs-string">type=gha,mode=max</span>
    
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">production</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">appleboy/ssh-action@v0.1.5</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.HOST</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.USERNAME</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.PRIVATE_KEY</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">script:</span> <span class="hljs-string">|
          docker pull myapp:latest
          docker-compose down
          docker-compose up -d
          docker system prune -f
</span></code></pre>
<h2 class="text-xl font-bold text-foreground mt-6 mb-3">배포 전략</h2>
<h3 class="text-lg font-semibold text-foreground mt-4 mb-2">Blue-Green 배포</h3>
<pre class="rounded-lg overflow-x-auto mb-4 bg-surface text-foreground p-4"><code class="hljs language-bash text-foreground px-2 py-1 rounded text-sm bg-surface-secondary border border-border bg-surface p-4 rounded-lg overflow-x-auto"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 현재 활성 환경 확인</span>
CURRENT=$(docker-compose ps -q app | <span class="hljs-built_in">wc</span> -l)

<span class="hljs-keyword">if</span> [ <span class="hljs-variable">$CURRENT</span> -eq 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-comment"># 첫 배포</span>
    docker-compose up -d
<span class="hljs-keyword">else</span>
    <span class="hljs-comment"># Blue-Green 배포</span>
    docker-compose -f docker-compose.blue.yml up -d
    
    <span class="hljs-comment"># 헬스 체크</span>
    <span class="hljs-built_in">sleep</span> 30
    <span class="hljs-keyword">if</span> curl -f http://localhost:3001/health; <span class="hljs-keyword">then</span>
        <span class="hljs-comment"># 트래픽 전환</span>
        docker-compose down
        docker-compose -f docker-compose.blue.yml down
        <span class="hljs-built_in">mv</span> docker-compose.blue.yml docker-compose.yml
        docker-compose up -d
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Deployment failed"</span>
        docker-compose -f docker-compose.blue.yml down
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">fi</span>
</code></pre>
<h3 class="text-lg font-semibold text-foreground mt-4 mb-2">Rolling 업데이트</h3>
<pre class="rounded-lg overflow-x-auto mb-4 bg-surface text-foreground p-4"><code class="hljs language-yaml text-foreground px-2 py-1 rounded text-sm bg-surface-secondary border border-border bg-surface p-4 rounded-lg overflow-x-auto"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">myapp:latest</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
      <span class="hljs-attr">update_config:</span>
        <span class="hljs-attr">parallelism:</span> <span class="hljs-number">1</span>
        <span class="hljs-attr">delay:</span> <span class="hljs-string">10s</span>
        <span class="hljs-attr">failure_action:</span> <span class="hljs-string">rollback</span>
        <span class="hljs-attr">order:</span> <span class="hljs-string">start-first</span>
      <span class="hljs-attr">rollback_config:</span>
        <span class="hljs-attr">parallelism:</span> <span class="hljs-number">1</span>
        <span class="hljs-attr">delay:</span> <span class="hljs-string">5s</span>
</code></pre>
<h2 class="text-xl font-bold text-foreground mt-6 mb-3">모니터링과 로깅</h2>
<h3 class="text-lg font-semibold text-foreground mt-4 mb-2">로그 수집</h3>
<pre class="rounded-lg overflow-x-auto mb-4 bg-surface text-foreground p-4"><code class="hljs language-yaml text-foreground px-2 py-1 rounded text-sm bg-surface-secondary border border-border bg-surface p-4 rounded-lg overflow-x-auto"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">logging:</span>
      <span class="hljs-attr">driver:</span> <span class="hljs-string">"json-file"</span>
      <span class="hljs-attr">options:</span>
        <span class="hljs-attr">max-size:</span> <span class="hljs-string">"10m"</span>
        <span class="hljs-attr">max-file:</span> <span class="hljs-string">"3"</span>
</code></pre>
<h3 class="text-lg font-semibold text-foreground mt-4 mb-2">헬스 체크</h3>
<pre class="rounded-lg overflow-x-auto mb-4 bg-surface text-foreground p-4"><code class="hljs language-dockerfile text-foreground px-2 py-1 rounded text-sm bg-surface-secondary border border-border bg-surface p-4 rounded-lg overflow-x-auto">HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1
</code></pre>
<h2 class="text-xl font-bold text-foreground mt-6 mb-3">보안 고려사항</h2>
<h3 class="text-lg font-semibold text-foreground mt-4 mb-2">멀티스테이지 빌드</h3>
<ul class="list-disc list-inside text-foreground-secondary mb-4 space-y-1">
<li class="text-foreground-secondary">프로덕션 이미지에서 개발 의존성 제거</li>
<li class="text-foreground-secondary">최소한의 런타임 환경 구성</li>
</ul>
<h3 class="text-lg font-semibold text-foreground mt-4 mb-2">비루트 사용자</h3>
<pre class="rounded-lg overflow-x-auto mb-4 bg-surface text-foreground p-4"><code class="hljs language-dockerfile text-foreground px-2 py-1 rounded text-sm bg-surface-secondary border border-border bg-surface p-4 rounded-lg overflow-x-auto">RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
USER nextjs
</code></pre>
<h3 class="text-lg font-semibold text-foreground mt-4 mb-2">시크릿 관리</h3>
<pre class="rounded-lg overflow-x-auto mb-4 bg-surface text-foreground p-4"><code class="hljs language-yaml text-foreground px-2 py-1 rounded text-sm bg-surface-secondary border border-border bg-surface p-4 rounded-lg overflow-x-auto"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">secrets:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">db_password</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">api_key</span>

<span class="hljs-attr">secrets:</span>
  <span class="hljs-attr">db_password:</span>
    <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">api_key:</span>
    <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span>
</code></pre>
<h2 class="text-xl font-bold text-foreground mt-6 mb-3">결론</h2>
<p class="text-foreground-secondary leading-relaxed mb-4">Docker를 활용한 배포는 일관된 환경, 확장성, 그리고 효율적인 리소스 관리를 제공합니다. 적절한 CI/CD 파이프라인과 함께 사용하면 안정적이고 빠른 배포가 가능합니다.</p>